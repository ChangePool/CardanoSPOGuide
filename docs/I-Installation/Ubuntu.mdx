---
title: "Hardening an Ubuntu Server"
sidebar_label: "Hardening an Ubuntu Server"
slug: /Ubuntu
hide_title: false
sidebar_position: 10
description: "How to secure a computer running Cardano Node"
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

import React from 'react';

export function HTMLContent() {
    return (
        <div>

            <h1>Set Up Ubuntu</h1>

            <p>Refer to the respective guide to <a href="https://ubuntu.com/tutorials/install-ubuntu-server" target="_blank">Install Ubuntu Server</a> or <a href="https://ubuntu.com/tutorials/install-ubuntu-desktop" target="_blank">Install Ubuntu Desktop</a>.</p>

        </div>
    );
}

<!-- <HTMLContent /> -->

Cardano stake pools operating on Mainnet hold significant value. Therefore, you need to secure each computer hosting an instance of Cardano Node, especially in your Mainnet stake pool configuration.

## Setting Up Ubuntu Desktop

The *How to Set Up a Cardano Stake Pool* guide assumes that you run the Cardano Node software application on computers using [Ubuntu 22.04 LTS Desktop](https://releases.ubuntu.com/jammy/).

:::note
For full details on supported operating systems for Cardano Node, see the [release notes](https://github.com/IntersectMBO/cardano-node/releases) for the latest version.
:::

**To install Ubuntu Desktop:**

1\. Follow the [Install Ubuntu Desktop](https://ubuntu.com/tutorials/install-ubuntu-desktop) tutorial.

2\. In the **Create Your Account** dialog, type `cardano` in the **Your Username** field. Complete the other fields in the dialog, and then click **Next**

3\. Complete the tutorial.

Alternately, if you plan to install Cardano Node using an existing Ubuntu Desktop installation, then create the `cardano` standard account using the command line.

**To create a standard account using the command line:**

1\. Using a terminal window, type:
```
# Create a new user named cardano
useradd -m -s /bin/bash cardano
# Set the password for the cardano user
passwd cardano
# Add the cardano user to the sudo group
usermod -aG sudo cardano
```

:::note
The hash character (`#`) indicates that the remainder of the line is a comment.
:::

Throughout the *How to Set Up a Cardano Stake Pool* guide, log in to a computer hosting Cardano Node using the `cardano` standard account. To perform administrative tasks, use the `sudo` or `su` command.

:::tip
For information on using `sudo` and `su` commands, see [Exploring the Differences between sudo and su Commands in Linux](https://www.redhat.com/en/blog/difference-between-sudo-su) for example.
:::

## :robot: Updating Your Computer

Keeping your computer up to date with the latest patches helps prevent intruders from gaining access to your computer illicitly.

**To update your computer:**

1\. Using a terminal window, type:
```bash
sudo apt-get update -y && sudo apt-get upgrade -y
sudo apt-get autoremove
sudo apt-get autoclean
```

Enabling automatic updates ensures that your computer installs updates automatically, so you do not need to install updates manually.

**To enable automatic updates:**

1\. Using a terminal window, type:
```
sudo apt-get install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

:::info
By default, the `unattended-upgrades` service only installs security updates automatically. For details on configuring unattended upgrades, see [How to Configure Unattended Upgrades](https://linuxcapable.com/how-to-configure-unattended-upgrades-on-ubuntu-linux/), for example.
:::

## Disabling the Root Account

The `root` account is the superuser account having unlimited administrative privileges to manage your computer. In Ubuntu 22.04, the `root` account is disabled by default.

Disabling the `root` account improves security because the known `root` username provides attackers a potential opportunity to crack a single password in order to gain full access to your computer. Disabling the `root` account also protects you from consquences of mistakes that you may make. For example, running an `rm` command accidentally as the `root` user may delete all files on your computer.

**To disable the `root` account:**

1. Using a terminal window, type `sudo passwd -l root` to lock the password for the `root` user.

:::note
If you need to enable the `root` account, type `sudo passwd -u root` to unlock the password for the `root` user.
:::

## Configuring Secure Shell

Secure Shell (SSH) is a cryptographic network protocol supporting robust authentication mechanisms to enable secure remote access to computers over an unsecured network. Using SSH, you can securely execute commands on a remote computer as if you are logged in locally to facilitate administration, software deployment and maintenance. Using SSH keys, you can automate tasks. You can also create secure tunnels forwarding network traffic using an encrypted SSH connection to access services on the remote computer using a private network instead of the Internet. SSH provides a secure and versatile foundation for managing and interacting with remote computers, protecting data confidentiality and integrity while enabling efficient remote operations.

**To configure SSH:**

1\. Follow the [How to Install SSH Server on Ubuntu](https://www.simplified.guide/ubuntu/install-ssh-server) tutorial.

2\. To set up a client connection, follow the [How to Connect to an SSH Server](https://www.howtogeek.com/311287/how-to-connect-to-an-ssh-server-from-windows-macos-or-linux/) tutorial.

3\. 




SSH to your server

```bash
ssh username@server.public.ip.address
# example
# ssh myUsername@77.22.161.10
```



### Disabling SSH Password Authentication and Using SSH Keys Only

:::info
The basic rules of hardening SSH are:

* No password for SSH access (use private key)
* Don't allow root to SSH (the appropriate users should SSH in, then `su` or `sudo`)
* Use `sudo` for users so commands are logged
* Log unauthorized login attempts (and consider software to block/ban users who try to access your server too many times, like fail2ban)
* Lock down SSH to only the ip range you require (if you feel like it)
:::

Create a new SSH key pair on your local machine. Run this on your local machine. You will be asked to type a file name in which to save the key. This will be your **keyname**.

Your choice of [ED25519 or RSA](https://goteleport.com/blog/comparing-ssh-keys/) public key algorithm.

<Tabs>
    <TabItem value="ED25519" label="ED25519" default>
        ```
        ssh-keygen -t ed25519
        ```
    </TabItem>
    <TabItem value="RSA" label="RSA">
        ```bash
        ssh-keygen -t rsa -b 4096
        ```
    </TabItem>
</Tabs>

Transfer the public key to your remote node. Update the **keyname**.

```bash
ssh-copy-id -i $HOME/.ssh/<keyname>.pub cardano@server.public.ip.address
```

Login with your new cardano user

```
ssh cardano@server.public.ip.address
```

Disable root login and password based login. Edit the `/etc/ssh/sshd_config file`

```
sudo nano /etc/ssh/sshd_config
```

Locate **PubkeyAuthentication** and update to yes. Delete the #, if needed.

```
PubkeyAuthentication yes
```

Locate **PasswordAuthentication** and update to no

```
PasswordAuthentication no 
```

Locate **PermitRootLogin** and update to prohibit-password

```
PermitRootLogin prohibit-password
```

Locate **PermitEmptyPasswords** and update to no

```
PermitEmptyPasswords no
```

**Optional**: Locate Port **and customize it to your random port number**.

:::info
Use a **random** port # from 1024 thru 49141. [Check for possible conflicts.](https://en.wikipedia.org/wiki/List\_of\_TCP\_and\_UDP\_port\_numbers)
:::

```bash
Port <port number>
```

Validate the syntax of your new SSH configuration.

```
sudo sshd -t
```

If no errors with the syntax validation, restart the SSH process.

```
sudo systemctl restart sshd
```

Verify the login still works


<Tabs>
    <TabItem value="Standard SSH Port 22" label="Standard SSH Port 22" default>
        ```
        ssh cardano@server.public.ip.address
        ```
    </TabItem>
    <TabItem value="Custom SSH Port" label="Custom SSH Port">
        ```bash
        ssh cardano@server.public.ip.address -p <custom port number>
        ```
    </TabItem>
</Tabs>

:::info
Alternatively, add the `-p <port#>` flag if you used a custom SSH port.

```bash
ssh -i <path to your SSH_key_name.pub> cardano@server.public.ip.address
```
:::

**Optional**: Make logging in easier by updating your local ssh config.

To simplify the ssh command needed to log in to your server, consider updating your local `$HOME/.ssh/config` file:

```bash
Host cardano-server
  User cardano
  HostName <server.public.ip.address>
  Port <custom port number>
```

This will allow you to log in with `ssh cardano-server` rather than needing to pass through all ssh parameters explicitly.

### Configuring Two Factor Authentication for SSH

:::info
SSH, the secure shell, is often used to access remote Linux systems. Because we often use it to connect with computers containing important data, it’s recommended to add another security layer. Here comes the two factor authentication (_2FA_).
:::

```
sudo apt install libpam-google-authenticator -y
```

To make SSH use the Google Authenticator PAM module, edit the `/etc/pam.d/sshd` file:

```
sudo nano /etc/pam.d/sshd 
```

Add the follow line:

```
auth required pam_google_authenticator.so
```

Now you need to restart the `sshd` daemon using:

```
sudo systemctl restart sshd.service
```

Modify `/etc/ssh/sshd_config`

```
sudo nano /etc/ssh/sshd_config
```

Locate **ChallengeResponseAuthentication** and update to yes

```
ChallengeResponseAuthentication yes
```

Locate **UsePAM** and update to yes

```
UsePAM yes
```

Save the file and exit.

Run the **google-authenticator** command.

```
google-authenticator
```

It will ask you a series of questions, here is a recommended configuration:

* Make tokens “time-base”": yes
* Update the `.google_authenticator` file: yes
* Disallow multiple uses: yes
* Increase the original generation time limit: no
* Enable rate-limiting: yes

You may have noticed the giant QR code that appeared during the process, underneath are your emergency scratch codes to be used if you don't have access to your phone: write them down on paper and keep them in a safe place.

Now, open Google Authenticator on your phone and add your secret key to make two factor authentication work.

:::danger
If you are enabling 2FA on a remote machine that you access over SSH you need to follow **steps 2 and 3** of [this tutorial](https://www.digitalocean.com/community/tutorials/how-to-set-up-multi-factor-authentication-for-ssh-on-ubuntu-18-04) to make 2FA work.
:::

## :jigsaw: Securing Shared Memory

:::info
One of the first things you should do is secure the shared [memory](https://www.lifewire.com/what-is-random-access-memory-ram-2618159) used on the system. If you're unaware, shared memory can be used in an attack against a running service. Because of this, secure that portion of system memory.

To learn more about securing shared memory, read this [techrepublic.com article](https://www.techrepublic.com/article/how-to-enable-secure-shared-memory-on-ubuntu-server/).
:::

:::warning
**One exceptional case**

There may be a reason for you needing to have that memory space mounted in read/write mode (such as a specific server application like **Chrome** that requires such access to the shared memory or standard applications like Google Chrome). In this case, use the following line for the fstab file with instructions below.

```
none /run/shm tmpfs rw,noexec,nosuid,nodev 0 0
```

The above line will mount the shared memory with read/write access but without permission to execute programs, change the UID of running programs, or to create block or character devices in the namespace. This a net security improvement over default settings.

**Use with caution**

With some trial and error, you may discover some applications (**like Chrome**) do not work with shared memory in read-only mode. For the highest security and if compatible with your applications, it is a worthwhile endeavor to implement this secure shared memory setting.

Source: [techrepublic.com](https://www.techrepublic.com/article/how-to-enable-secure-shared-memory-on-ubuntu-server/)
:::

Edit `/etc/fstab`

```
sudo nano /etc/fstab
```

Insert the following line to the bottom of the file and save/close.

```
tmpfs	/run/shm	tmpfs	ro,noexec,nosuid	0 0
```

Reboot the node in order for changes to take effect.

```
sudo reboot
```

## :chains: Installing fail2ban

:::info
Fail2ban is an intrusion-prevention system that monitors log files and searches for particular patterns that correspond to a failed login attempt. If a certain number of failed logins are detected from a specific IP address (within a specified amount of time), fail2ban blocks access from that IP address.
:::

```
sudo apt-get install fail2ban -y
```

Edit a config file that monitors SSH logins.

```
sudo nano /etc/fail2ban/jail.local
```

Add the following lines to the bottom of the file.

:::info
:fire: **Whitelisting IP address tip**: The `ignoreip` parameter accepts IP addresses, IP ranges or DNS hosts that you can specify to be allowed to connect. This is where you want to specify your local machine, local IP range or local domain, separated by spaces.

```
# Exampleignoreip = 192.168.1.0/24 127.0.0.1/8 
```
:::

```bash
[sshd]
enabled = true
port = <22 or your random port number>
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
# whitelisted IP addresses
ignoreip = <list of whitelisted IP address, your local daily laptop/pc>
```

Save/close file.

Restart fail2ban for settings to take effect.

```
sudo systemctl restart fail2ban
```

## Configuring Your Firewall <a href="#ufw" id="ufw"></a>

The standard UFW firewall can be used to control network access to your node.

With any new installation, UFW is disabled by default. Enable UFW. Assuming that you use the default profile allowing outgoing traffic and denying incoming traffic, open the following ports to incoming traffic:

* Port 22 (or your random port #) TCP for SSH connection
* Port 123 UDP for chrony ntp
* Port 6000 TCP for Cardano network traffic

If you install a Grafana dashboard for monitoring your Cardano stake pool, then also open the following ports in UFW:

* Port 3000 TCP for Grafana web server
* Port 9100 TCP for Prometheus Node Exporter data
* Port 12798 TCP for Cardano Node data for Prometheus

```bash
# By default, deny all incoming traffic and allow outgoing traffic.
sudo ufw default deny incoming
sudo ufw default allow outgoing
# Allow ssh access
sudo ufw allow ssh #<port 22 or your random ssh port number>/tcp
# Allow cardano-node p2p port
sudo ufw allow 6000/tcp
# Enable firewall
sudo ufw enable
```

```bash
# Verify status
sudo ufw status numbered
```

:::danger
Do not expose Grafana (port 3000) and Prometheus endpoint (port 9100 and 12798) to the public internet as this invites a new attack surface!
:::

**Better idea - SSH tunnel to Grafana server**

Setup a SSH tunnel with the following command:

```
ssh -L 3000:localhost:3000 <user>@<your-server-ip-or-dns>
```

Alternatively, If using Putty for SSHing, you can configure the tunnel as follows. Make sure to click "Add" and save your new profile settings.

![](@site/static/img/putty-tunnel.png)

:::tip
Now you can access the Grafana server from your local machine's browser by visiting http://localhost:3000
:::

Only open the following ports on nodes behind a network firewall. This is not required if using the above SSH tunnel method.

:fire: **It is dangerous to open these ports on a VPS/cloud node.**

```bash
# Allow grafana web server port
sudo ufw allow 3000/tcp
# Allow prometheus endpoint port
sudo ufw allow 9100/tcp
# Allow prometheus cardano-node metric data port
sudo ufw allow 12798/tcp
```

Confirm the settings are in effect.

> ```csharp
>      To                         Action      From
>      --                         ------      ----
> [ 1] 22/tcp                     ALLOW IN    Anywhere
> [ 2] 3000/tcp                   ALLOW IN    Anywhere
> [ 3] 6000/tcp                   ALLOW IN    Anywhere
> [ 4] 22/tcp (v6)                ALLOW IN    Anywhere (v6)
> [ 5] 3000/tcp (v6)              ALLOW IN    Anywhere (v6)
> [ 6] 6000/tcp (v6)              ALLOW IN    Anywhere (v6)
> ```

**\[ Optional but recommended ]** Whitelisting (or permitting connections from a specific IP) can be setup via the following command.

```bash
sudo ufw allow from <your local daily laptop/pc>
# Example
# sudo ufw allow from 192.168.50.22
```

:::info
**Port Forwarding Tip:** You'll need to forward and open ports to your validator. Verify it's working with [https://www.yougetsignal.com/tools/open-ports/](https://www.yougetsignal.com/tools/open-ports/) or [https://canyouseeme.org/](https://canyouseeme.org) .
:::

#### Additional Hardening Rules for a Block-producing Node

Only your Relay Node(s) should be permitted access to your Block Producer Node.

```bash
sudo ufw allow proto tcp from <RELAY NODE IP> to any port <BLOCK PRODUCER PORT>
# Example
# sudo ufw allow proto tcp from 18.58.3.31 to any port 6000
```

#### Additional Hardening Rules for Relay Nodes

In order to protect your Relay Node(s) from a novel "DoS/Syn" attack, [**Michael Fazio**](https://github.com/michaeljfazio) created iptables entry which restricts connections to a given destination port to 5 connections from the same IP.

Replace `<RELAY NODE PORT>` with your public relay port, replace the 5 with your preferred connection limit.

```bash
sudo iptables -I INPUT -p tcp -m tcp --dport <RELAY NODE PORT> --tcp-flags FIN,SYN,RST,ACK SYN -m connlimit --connlimit-above 5 --connlimit-mask 32 --connlimit-saddr -j REJECT --reject-with tcp-reset
```

:::warning
Set the connection limit high enough so that your internal relay/block producer node topology remains functional.
:::

:fire: **iptables rules applied via terminal are not reboot-resistant!**

You can check your current connections with a sorted list. Change the relay node port number, if needed.

```bash
sudo netstat -enp | grep ":6000" | awk {'print $5'} | cut -d ':' -f 1 | sort | uniq -c | sort
```

DDoS/Syn attacks can be complex and can take down a node. A single iptables rule may not be sufficient to protect or mitigate against more modern attacks. Moreover, iptables rules added via the terminal are forgotten if the machine or the iptables service is restarted.

Carden Pool [CRPL] provides a script that configures and deploys iptables rules specifically designed to protect from various DDoS attack vectors, ensuring the persistence of these rules even after reboots.

Further information can be found in the [**Carden Pool GitHub repository**](https://github.com/CardenPool/stakepool-DDoS-defense).

## :telescope: Verifying Listening Ports

If you want to maintain a secure server, you should validate the listening network ports every once in a while. This will provide you essential information about your network.

```
netstat -tulpn
```

```
ss -tulpn
```

:::tip
Congrats on completing the guide. :sparkles:

Did you find our guide useful? Send us a signal with a tip and we'll keep updating it.

It really energizes us to keep creating the best crypto guides.

Use [cointr.ee to find our donation ](https://cointr.ee/coincashew)addresses. :pray:

Any feedback and all pull requests much appreciated.

Hang out and chat with our stake pool community on Telegram @ [https://t.me/coincashew](https://t.me/coincashew)
:::

## :rocket: References

[How to Harden your Ubuntu 18.04 Server](https://medium.com/@BaneBiddix/how-to-harden-your-ubuntu-18-04-server-ffc4b6658fe7)

[Ubuntu System Hardening Guide for Desktops and Servers](https://linux-audit.com/ubuntu-server-hardening-guide-quick-and-secure/)

[How To Harden OpenSSH on Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-harden-openssh-on-ubuntu-18-04)

[Configure SSH to Use Two-factor Authentication](https://ubuntu.com/tutorials/configure-ssh-2fa)

[Ubuntu Hardening](https://gist.github.com/lokhman/cc716d2e2d373dd696b2d9264c0287a3#file-ubuntu-hardening-md)

[50 Best Linux Hardening Security Tips: A Comprehensive Checklist](https://www.ubuntupit.com/best-linux-hardening-security-tips-a-comprehensive-checklist/)

