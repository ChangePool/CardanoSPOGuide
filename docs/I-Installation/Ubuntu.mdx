---
title: "Hardening an Ubuntu Server"
sidebar_label: "Hardening an Ubuntu Server"
slug: /Ubuntu
hide_title: false
sidebar_position: 10
description: "How to secure a computer running Cardano Node"
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

import React from 'react';

export function HTMLContent() {
    return (
        <div>



        </div>
    );
}

<!-- <HTMLContent /> -->

Cardano stake pools operating on Mainnet hold significant value. Therefore, you need to secure each computer hosting an instance of Cardano Node, especially in your Mainnet stake pool configuration.

Hardening a computer involves reducing the number of vulnerabilities and entry points that attackers may exploit. Complete the following procedures on each computer hosting Cardano Node:

- When [Setting Up Ubuntu Desktop](#setting-up-ubuntu-desktop), create a standard account to log in to the computer.
- To perform administrative tasks on the computer, use `sudo` or `su`
- To [Configure Secure Shell](#configuring-secure-shell) connections:
    - [Implement key authentication](#implementing-key-authentication)
    - Disable password authentication
    - Change the Listening Port Number
    - [Simplify Logging In](#simplifying-logging-in)
    - [Set Up Two-factor Authentication](#setting-up-two-factor-authentication)
- [Disable the Root Account](#disabling-the-root-account) on the computer.
- [Secure Shared Memory](#jigsaw-securing-shared-memory) on the computer.
- [Install fail2ban](#chains-installing-fail2ban) to block and log unauthorized login attempts.
- [Configure a Firewall](#configuring-a-firewall-) to control network access to the computer.
- [Validate Listening Ports](#telescope-validating-listening-ports) on the computer regularly.
- [Update Your Computer](#robot-updating-your-computer) regularly or automatically.

## Setting Up Ubuntu Desktop

The *How to Set Up a Cardano Stake Pool* guide assumes that you run the Cardano Node software application on computers using [Ubuntu 22.04 LTS Desktop](https://releases.ubuntu.com/jammy/).

:::note
For full details on supported operating systems for Cardano Node, see the [release notes](https://github.com/IntersectMBO/cardano-node/releases) for the latest version.
:::

**To install Ubuntu Desktop:**

1\. Follow the [Install Ubuntu Desktop](https://ubuntu.com/tutorials/install-ubuntu-desktop) tutorial.

2\. In the **Create Your Account** dialog, type `cardano` in the **Your Username** field. Complete the other fields in the dialog, and then click **Next**

3\. Complete the tutorial.

Alternately, if you plan to install Cardano Node using an existing Ubuntu Desktop installation, then create the `cardano` standard account using the command line.

**To create a standard account using the command line:**

1\. Using a terminal window, type:
```
# Create a new user named cardano
useradd -m -s /bin/bash cardano
# Set the password for the cardano user
passwd cardano
# Add the cardano user to the sudo group
usermod -aG sudo cardano
```

:::note
The hash character (#) indicates that the remainder of the line is a comment.
:::

Throughout the *How to Set Up a Cardano Stake Pool* guide, log in to a computer hosting Cardano Node using the `cardano` standard account. To perform administrative tasks, use the `sudo` or `su` command.

:::tip
For information on using `sudo` and `su` commands, see [Exploring the Differences between sudo and su Commands in Linux](https://www.redhat.com/en/blog/difference-between-sudo-su) for example.
:::

Setting a static IP address provides reliable remote access to the services operating on a computer, such as Secure Shell and Cardano Node.

**To configure a static IP address:**

1\. Follow the [Static IP Configuration](https://linuxconfig.org/how-to-configure-static-ip-address-on-ubuntu-18-10-cosmic-cuttlefish-linux) tutorial.

## Configuring Secure Shell

Secure Shell (SSH) is a cryptographic network protocol supporting robust authentication mechanisms to enable secure remote access to computers over an unsecured network. Using SSH, you can securely execute commands on a remote computer as if you are logged in locally to facilitate administration, software deployment and maintenance. Using SSH keys, you can automate tasks. You can also create secure tunnels forwarding network traffic using an encrypted SSH connection to access services on the remote computer using a private network instead of the Internet. SSH provides a secure and versatile foundation for managing and interacting with remote computers, protecting data confidentiality and integrity while enabling efficient remote operations.

**To configure SSH:**

1\. On the computer that you want to access remotely, follow the [How to Install SSH Server on Ubuntu](https://www.simplified.guide/ubuntu/install-ssh-server) tutorial.

2\. To connect to the computer where you installed SSH Server in step 1 using Linux, type the following command using a terminal window where `<Username>` identifies your Linux account on the computer hosting SSH Server—that is, `cardano` when using the *How to Set Up a Cardano Stake Pool* guide—and `<SSHServer>` is the IP address or domain name where the SSH Server listens:
```bash
ssh <Username>@<SSHServer>
```
:::info
For more details on setting up an SSH client connection, see [How to Connect to an SSH Server](https://www.howtogeek.com/311287/how-to-connect-to-an-ssh-server-from-windows-macos-or-linux/), for example.
:::

### Implementing Key Authentication

Implementing SSH key authentication and disabling SSH password authentication on a computer enhances security.

**To implement SSH key authentication:**

1\. To create a new SSH key pair, on a computer connecting to the SSH Server as a client, using a terminal window type:
```
ssh-keygen -t ed25519
```

:::note
The command creates an SSH key pair using Ed25519 encryption. You can also create an SSH key pair using RSA, DSA or ECDSA encryption. For more details, see [Comparing SSH Keys](https://goteleport.com/blog/comparing-ssh-keys/).
:::

2\. When prompted for a file name to save the key, press ENTER to accept the default `~/.ssh/id_ed25519`

:::note
In Linux, the tilde (~) symbol represents the home directory for the current user, typically `/home/<Username>` where `<Username>` is the name of the current user.
:::

3\. When prompted, type an appropriate passphrase, and then press ENTER

4\. To copy the public key that you created in steps 1 to 3 to the computer hosting the SSH Server, type the following command where `<KeyFileName>` is the file name that you typed in step 2, `<Username>` is `cardano` and `<SSHServer>` is the IP address or domain name where the SSH Server listens:
```bash
ssh-copy-id -i $HOME/.ssh/<KeyFileName>.pub <Username>@<SSHServer>
```

5.\ To connect to the computer hosting the SSH Server, type the following command where `<SSHServer>` is the IP address or domain name where the SSH Server listens:
```bash
ssh cardano@<SSHServer>
```

6\. To edit the `sshd_config` file on the computer hosting the SSH Server, type the following command in the remote terminal window:
```
sudo nano /etc/ssh/sshd_config
```

7\. Edit the following lines, where `<PortNumber>` is a port number between 1024 and 49151 that is unused on the computer hosting the SSH Server:
```bash
# Specify the port where the SSH Server listens
Port <PortNumber>
# Permit root login using public key authentication only
PermitRootLogin prohibit-password
# Allow public key authentication
PubkeyAuthentication yes 
# Do not allow password authentication
PasswordAuthentication no
# When password authentication is allowed, do not allow empty password strings
PermitEmptyPasswords no
```

:::note
If any of the lines containing keyword-argument pairs begin with a hash (#) character, then remove the hash character. To check port numbers for potential conflicts, refer to the [List of TCP and UDP Port Numbers](https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers).
:::

8\. Save and close the `sshd_config` file.

9\. To validate the syntax of the `sshd_config` file, type:
```
sudo sshd -t
```

10\. If validating the `sshd_config` file returns no errors, then type the following command to restart the SSH Server:
```
sudo systemctl restart sshd
```

11\. To verify that you can connect to the SSH Server using public key authentication, type the following command on the computer connecting to the SSH Server as a client where `<SSHServer>` is the IP address or domain name where the SSH Server listens and `<PortNumber>` is the port number that you set in step 7:
```bash
ssh -i ~/.ssh/id_ed25519 cardano@<SSHServer> -p <PortNumber>
```

### Simplifying Logging In

The SSH configuration file located at `~/.ssh/config` on the client computer stores user-specific connection details.

**To simplify logging in to a computer using SSH:**

1\. On the client computer, type:
```
nano ~/.ssh/config
```

2\. In the `config` file, add the following lines where `<SSHServer>` is the IP address or domain name where the SSH Server listens and `<PortNumber>` is the port number where the SSH Server listens:
```bash
Host cardano-server
  User cardano
  HostName <SSHServer>
  Port <PortNumber>
```

3\. Save and close the `config` file.

4\. To log in using the connection details specified in the `config` file, type:
```
ssh cardano-server
```

### Setting Up Two-factor Authentication

Using two-factor authentication (2FA) for SSH significantly enhances the security of remote server access by adding an extra layer of verification beyond key authentication.

:::warning
If you connect remotely to a computer hosting SSH Server to configure two-factor authentication, then you may not regain remote access if you make an error in the configuration.
:::

**To set up two-factor authentication for SSH:**

1\. Using a terminal window on the computer hosting SSH Server, type:
```
sudo apt-get update
sudo apt install libpam-google-authenticator
```

2\. To edit the Pluggable Authentication Module (PAM) configuration file, type:
```
sudo nano /etc/pam.d/sshd
```

3\. In the `sshd` file, insert a hash (#) character to edit the following line:
```
# Standard Un*x authentication.
#@include common-auth
```

4\. At the end of the `sshd` file, add the following line, and then save and close the file:
```
auth required pam_google_authenticator.so
```

5\. To edit the SSH Server configuration file, type:
```
sudo nano /etc/ssh/sshd_config
```

6\. In the `sshd_config` file, edit the following lines:
```
UsePAM yes
KbdInteractiveAuthentication yes
```

7\. At the end of the `sshd_config` file, add the following line, and then save and close the file:
```
AuthenticationMethods publickey,keyboard-interactive
```

8\. To restart the SSH Server, type:
```
sudo systemctl restart sshd.service
```

9\. To configure Google Authenticator, type:
```
google-authenticator
```

10\. Respond to the questions that Google Authenticator displays using the following answers:
* **Use time-based Tokens**—Yes
* **Update the `.google_authenticator` File**—Yes
* **Disallow Multiple Uses**—Yes
* **Increase Time Window**—No
* **Enable Rate Limiting**—Yes

11\. Safely record the Secret Key and Emergency Scratch Codes that Google Authenticator generates in step 10

12\. Reboot the computer hosting SSH Server.

13\. Using an authenticator app installed on a mobile device or computer connecting to the SSH Server as a client, add the Secret Key that you recorded in step 11

**To test two-factor authentication:**

1\. On a client computer where you [Implemented Key Authentication](#implementing-key-authentication) and [Simplified Logging In](#simplifying-logging-in), open a terminal window and then type the following command:
```
ssh cardano-server
```

2\. Follow the steps on screen to complete two-factor authentication.

### Verifying and Troubleshooting Configuration

SSH Server uses a modular, drop-in functionality for configuration that many Linux applications and services use.

The `/etc/ssh/sshd-config.d` directory contains configuration files processed in alphabetical order by file name via the `Include /etc/ssh/sshd_config.d/*.conf` statement found as the first line in the file `/etc/ssh/sshd-config` Many applications apply the last definition of a configuration option. However, SSH Server applies the first definition of a configuration option. Therefore, if a configuration file found in the `sshd-config.d` folder sets an option also set in the `sshd-config` file, then the option set in the `sshd-config` file may not apply.

**To verify SSH Server settings:**

1\. Using a terminal window on the computer hosting SSH Server, to display the options that the SSH Server currently applies, type:
```
sudo sshd -T
```

2\. Verify that the SSH Server applies the following options, where `<PortNumber>` is the port number that you set when [Implementing Key Authentication](#implementing-key-authentication):
```
Port <PortNumber>
PermitRootLogin prohibit-password
PubkeyAuthentication yes
PasswordAuthentication no
PermitEmptyPasswords no
UsePAM yes
KbdInteractiveAuthentication yes
```

3\. If the SSH Server does NOT apply one or more of the options listed in step 2, then examine the contents of the configuration files found in the `/etc/ssh/sshd-config.d` directory to identify the configuration file(s) setting the same option(s) before the `sshd-config` file sets the options.

4\. To resolve conflicting configuration options, create a file in the `/etc/ssh/sshd-config.d` directory having a file name that appears earlier in alphabetical order than the name of configuration files setting unwanted options, and then set the desired configuration options in the file you create. For example, if a configuration file named `50-cloud-init.conf` sets `PasswordAuthentication yes` then you may create a file named `01-custom-ssh.conf` containing `PasswordAuthentication no` to apply the necessary option.

5\. To restart the SSH Server, type:
```
sudo systemctl restart sshd.service
```

6\. If you edited configuration options in step 4, then go to step 1, and then verify that the options the SSH Server applies are now correct.

## Disabling the Root Account

The `root` account is the superuser account having unlimited administrative privileges to manage your computer. In Ubuntu 22.04, the `root` account is disabled by default.

Disabling the `root` account improves security because the known `root` username provides attackers a potential opportunity to crack a single password in order to gain full access to your computer. Disabling the `root` account also protects you from consquences of mistakes that you may make. For example, running an `rm` command accidentally as the `root` user may delete all files on your computer.

**To disable the `root` account:**

1. Using a terminal window, type `sudo passwd -l root` to lock the password for the `root` user.

:::note
If you need to enable the `root` account, type `sudo passwd -u root` to unlock the password for the `root` user.
:::

## :jigsaw: Securing Shared Memory

In Linux operating systems, shared memory allows multiple processes to access a common region of memory for fast, high-speed data exchange and communication. Any changes to shared memory are visible to all processes having access to the memory region. Shared memory is the most efficient form of inter-process communication (IPC).

Attackers may exploit shared memory to execute arbitrary code or escalate execution privileges.

Securing shared memory may involve modifying mount options for the shared memory filesystem to prevent:

* Writing data
* Executing arbitrary code
* Escalating privileges
* Interpreting files that provide direct access to hardware devices

:::warning
Ensure that measures you implement to secure shared memory are compatible with all applications running on the computer. For example, Web browsers may require read and write access to shared memory for rendering and caching.
:::

**To secure shared memory:**

1\. Using a terminal window, type:
```
sudo nano /etc/fstab
```

2\. At the end of the `fstab` file, add the following line to mount the shared memory filesystem securely using read-write access:
```
tmpfs /run/shm tmpfs defaults,nodev,nosuid,noexec 0 0
```

<center><strong>OR</strong></center>

If you are sure that no applications on the computer may require write access to the shared memory filesystem, then add the following line to mount the filesystem using read-only access:
```
tmpfs /run/shm tmpfs ro,noexec,nosuid 0 0
```

3\. Save and close the `fstab` file, and then reboot the computer.

<!-- The following options have been considered:
tmpfs /run/shm tmpfs defaults,noexec,nosuid 0 0
none /run/shm tmpfs rw,noexec,nosuid,nodev 0 0
tmpfs /run/shm tmpfs ro,noexec,nosuid 0 0

tmpfs /run/shm tmpfs defaults,nodev,nosuid,noexec 0 0 is compatible with PostreSQL
     
For more details, see the AI results of the following Google searches:
  - "ubuntu fstab none /run/shm tmpfs rw,noexec,nosuid,nodev 0 0 vs tmpfs /run/shm tmpfs defaults,noexec,nosuid 0 0"
  - "list of applications having issues with read-only shared memory ubuntu"
-->

<!-- 250919 - START HERE -->

## :chains: Installing fail2ban

:::info
[Fail2ban](https://github.com/fail2ban/fail2ban) is an intrusion-prevention system that monitors log files and searches for particular patterns that correspond to a failed login attempt. If a certain number of failed logins are detected from a specific IP address (within a specified amount of time), fail2ban blocks access from that IP address.
:::

```
sudo apt-get install fail2ban -y
```

Edit a config file that monitors SSH logins.

```
sudo nano /etc/fail2ban/jail.local
```

Add the following lines to the bottom of the file.

:::info
:fire: **Whitelisting IP address tip**: The `ignoreip` parameter accepts IP addresses, IP ranges or DNS hosts that you can specify to be allowed to connect. This is where you want to specify your local machine, local IP range or local domain, separated by spaces.

```
# Exampleignoreip = 192.168.1.0/24 127.0.0.1/8 
```
:::

```bash
[sshd]
enabled = true
port = <22 or your random port number>
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
# whitelisted IP addresses
ignoreip = <list of whitelisted IP address, your local daily laptop/pc>
```

Save/close file.

Restart fail2ban for settings to take effect.

```
sudo systemctl restart fail2ban
```

## Configuring a Firewall <a href="#ufw" id="ufw"></a>

The standard UFW firewall can be used to control network access to your node.

With any new installation, UFW is disabled by default. Enable UFW. Assuming that you use the default profile allowing outgoing traffic and denying incoming traffic, open the following ports to incoming traffic:

* Port 22 (or your random port #) TCP for SSH connection
* Port 123 UDP for chrony ntp
* Port 6000 TCP for Cardano network traffic

If you install a Grafana dashboard for monitoring your Cardano stake pool, then also open the following ports in UFW:

* Port 3000 TCP for Grafana web server
* Port 9100 TCP for Prometheus Node Exporter data
* Port 12798 TCP for Cardano Node data for Prometheus

```bash
# By default, deny all incoming traffic and allow outgoing traffic.
sudo ufw default deny incoming
sudo ufw default allow outgoing
# Allow ssh access
sudo ufw allow ssh #<port 22 or your random ssh port number>/tcp
# Allow cardano-node p2p port
sudo ufw allow 6000/tcp
# Enable firewall
sudo ufw enable
```

```bash
# Verify status
sudo ufw status numbered
```

:::danger
Do not expose Grafana (port 3000) and Prometheus endpoint (port 9100 and 12798) to the public internet as this invites a new attack surface!
:::

**Better idea - SSH tunnel to Grafana server**

Setup a SSH tunnel with the following command:

```
ssh -L 3000:localhost:3000 <user>@<your-server-ip-or-dns>
```

Alternatively, If using Putty for SSHing, you can configure the tunnel as follows. Make sure to click "Add" and save your new profile settings.

![](@site/static/img/putty-tunnel.png)

:::tip
Now you can access the Grafana server from your local machine's browser by visiting http://localhost:3000
:::

Only open the following ports on nodes behind a network firewall. This is not required if using the above SSH tunnel method.

:fire: **It is dangerous to open these ports on a VPS/cloud node.**

```bash
# Allow grafana web server port
sudo ufw allow 3000/tcp
# Allow prometheus endpoint port
sudo ufw allow 9100/tcp
# Allow prometheus cardano-node metric data port
sudo ufw allow 12798/tcp
```

Confirm the settings are in effect.

> ```csharp
>      To                         Action      From
>      --                         ------      ----
> [ 1] 22/tcp                     ALLOW IN    Anywhere
> [ 2] 3000/tcp                   ALLOW IN    Anywhere
> [ 3] 6000/tcp                   ALLOW IN    Anywhere
> [ 4] 22/tcp (v6)                ALLOW IN    Anywhere (v6)
> [ 5] 3000/tcp (v6)              ALLOW IN    Anywhere (v6)
> [ 6] 6000/tcp (v6)              ALLOW IN    Anywhere (v6)
> ```

**\[ Optional but recommended ]** Whitelisting (or permitting connections from a specific IP) can be setup via the following command.

```bash
sudo ufw allow from <your local daily laptop/pc>
# Example
# sudo ufw allow from 192.168.50.22
```

:::info
**Port Forwarding Tip:** You'll need to forward and open ports to your validator. Verify it's working with [https://www.yougetsignal.com/tools/open-ports/](https://www.yougetsignal.com/tools/open-ports/) or [https://canyouseeme.org/](https://canyouseeme.org) .
:::

#### Additional Hardening Rules for a Block-producing Node

Only your Relay Node(s) should be permitted access to your Block Producer Node.

```bash
sudo ufw allow proto tcp from <RELAY NODE IP> to any port <BLOCK PRODUCER PORT>
# Example
# sudo ufw allow proto tcp from 18.58.3.31 to any port 6000
```

#### Additional Hardening Rules for Relay Nodes

In order to protect your Relay Node(s) from a novel "DoS/Syn" attack, [**Michael Fazio**](https://github.com/michaeljfazio) created iptables entry which restricts connections to a given destination port to 5 connections from the same IP.

Replace `<RELAY NODE PORT>` with your public relay port, replace the 5 with your preferred connection limit.

```bash
sudo iptables -I INPUT -p tcp -m tcp --dport <RELAY NODE PORT> --tcp-flags FIN,SYN,RST,ACK SYN -m connlimit --connlimit-above 5 --connlimit-mask 32 --connlimit-saddr -j REJECT --reject-with tcp-reset
```

:::warning
Set the connection limit high enough so that your internal relay/block producer node topology remains functional.
:::

:fire: **iptables rules applied via terminal are not reboot-resistant!**

You can check your current connections with a sorted list. Change the relay node port number, if needed.

```bash
sudo netstat -enp | grep ":6000" | awk {'print $5'} | cut -d ':' -f 1 | sort | uniq -c | sort
```

DDoS/Syn attacks can be complex and can take down a node. A single iptables rule may not be sufficient to protect or mitigate against more modern attacks. Moreover, iptables rules added via the terminal are forgotten if the machine or the iptables service is restarted.

Carden Pool [CRPL] provides a script that configures and deploys iptables rules specifically designed to protect from various DDoS attack vectors, ensuring the persistence of these rules even after reboots.

Further information can be found in the [**Carden Pool GitHub repository**](https://github.com/CardenPool/stakepool-DDoS-defense).

## :telescope: Validating Listening Ports

If you want to maintain a secure server, you should validate the listening network ports every once in a while. This will provide you essential information about your network.

```
netstat -tulpn
```

```
ss -tulpn
```

## :robot: Updating Your Computer

Keeping your computer up to date with the latest patches helps prevent intruders from gaining access to your computer illicitly.

**To update your computer:**

1\. Using a terminal window, type:
```bash
sudo apt-get update -y && sudo apt-get upgrade -y
sudo apt-get autoremove
sudo apt-get autoclean
```

Enabling automatic updates ensures that your computer installs updates automatically, so you do not need to install updates manually.

**To enable automatic updates:**

1\. Using a terminal window, type:
```
sudo apt-get install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

:::info
By default, the `unattended-upgrades` service only installs security updates automatically. For details on configuring unattended upgrades, see [How to Configure Unattended Upgrades](https://linuxcapable.com/how-to-configure-unattended-upgrades-on-ubuntu-linux/), for example.
:::

## :rocket: Additional Resources

The procedures above are based on the following online resources, listed in alphabetical order:

- [50 Best Linux Hardening Security Tips: A Comprehensive Checklist](https://www.ubuntupit.com/best-linux-hardening-security-tips-a-comprehensive-checklist/)
- [Configure SSH to Use Two-factor Authentication](https://ubuntu.com/tutorials/configure-ssh-2fa)
- [How To Harden OpenSSH on Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-harden-openssh-on-ubuntu-18-04)
- [How to Harden Your Ubuntu 18.04 Server](https://medium.com/@BaneBiddix/how-to-harden-your-ubuntu-18-04-server-ffc4b6658fe7)
- [Ubuntu Hardening](https://gist.github.com/lokhman/cc716d2e2d373dd696b2d9264c0287a3#file-ubuntu-hardening-md)
- [Ubuntu System Hardening Guide for Desktops and Servers](https://linux-audit.com/ubuntu-server-hardening-guide-quick-and-secure/)

